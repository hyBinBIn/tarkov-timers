<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EFT 상인 리셋 타이머</title>
<style>
  :root { color-scheme: light dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 14px; }
  h2 { margin: 0 0 12px; font-size: 18px; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px,1fr)); gap: 12px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
  .name { font-weight: 700; margin-bottom: 4px; }
  .time { font-size: 1.1rem; }
  .hint { color: #666; font-size: 12px; margin-top: 6px; }
  .error { color: #c00; white-space: pre-wrap; }
  .bar  { height: 6px; background: #eee; border-radius: 99px; overflow: hidden; margin-top: 6px; }
  .fill { height: 100%; width: 0%; background: #6aa9ff; transition: width 0.2s linear; }
  .footer { color:#666; font-size:12px; margin-top:10px }
</style>

<h2>타르코프 상인 리셋 타이머</h2>
<div id="app">불러오는 중…</div>
<div class="footer">Data: eft-ammo (<code>/api/resetTimers</code>) · Rendered client-side</div>

<script>
const PROXY_BASE = "/api/eft-proxy?url=";
const DEFAULT_SOURCE = "https://www.eft-ammo.com/api/resetTimers";
const SLOT_MS_FALLBACK = 2 * 60 * 60 * 1000;

const qs = new URLSearchParams(location.search);
const RAW_TARGET = qs.get("url") || DEFAULT_SOURCE;
const ENDPOINT = PROXY_BASE + encodeURIComponent(RAW_TARGET);

function h(tag, attrs={}, ...kids) {
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) (k==="class"?el.className=v:el.setAttribute(k,v));
  kids.flat().forEach(k => el.append(k?.nodeType ? k : String(k)));
  return el;
}
function fmtRemain(ms){
  if(ms<0)ms=0;
  const s=Math.floor(ms/1000);
  const hh=String(Math.floor(s/3600)).padStart(2,"0");
  const mm=String(Math.floor((s%3600)/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}
function toSeoul(ts){
  const d=new Date(ts);
  return new Intl.DateTimeFormat("ko-KR",{
    timeZone:"Asia/Seoul",year:"numeric",month:"2-digit",day:"2-digit",
    hour:"2-digit",minute:"2-digit",second:"2-digit"
  }).format(d);
}

// ✅ 정확 매핑
function parseRow(x){
  const name=(x.name||"").replace(/^\w/,c=>c.toUpperCase());
  const nextTs=Date.parse(x.resetTimestamp); // "2025-10-01T04:21:09.000Z"
  return { name, nextTs, secondsLeft:null, totalSeconds:null };
}

async function main(){
  const app=document.getElementById("app");
  try{
    const r=await fetch(ENDPOINT);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const raw=await r.json();

    // ✅ 배열 경로 확정
    const arr = raw?.data?.traderResetTimes ?? [];
    if(!Array.isArray(arr) || arr.length===0){
      app.innerHTML='<div class="error">타이머 데이터가 비어있거나 구조가 다릅니다. 응답 JSON을 확인하세요.</div>';
      console.debug("raw response:", raw);
      return;
    }

    const list=arr.map(parseRow).filter(r=>r.name && !isNaN(r.nextTs));
    const grid=h("div",{class:"grid"}, list.map(row=>{
      const timer=h("div",{class:"time"},"—");
      const abs=h("div",{class:"hint"},"(한국 시간: "+toSeoul(row.nextTs)+")");
      const card=h("div",{class:"card"},
        h("div",{class:"name"},row.name),
        timer,abs
      );

      function tick(){
        const remainMs=row.nextTs - Date.now();
        timer.textContent=`다음 리셋까지 ${fmtRemain(remainMs)}`;
      }
      tick();
      setInterval(tick,1000);
      return card;
    }));

    app.replaceChildren(grid);
  }catch(e){
    app.innerHTML=`<div class="error">불러오기 실패: ${String(e)}</div>`;
  }
}
main();
</script>

</html>

